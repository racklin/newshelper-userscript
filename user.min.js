// ==UserScript==
// @name        newshelper
// @namespace   newshelper-userscript.g0v.tw
// @description g0v News Helper
// @author         racklin@gmail.com
// @include     https://www.facebook.com/*
// @include     http://www.facebook.com/*
// @match     https://www.facebook.com/*
// @match     http://www.facebook.com/*
// @run-at         document-end
// @require        http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.min.js
// @version     1.0.2
// ==/UserScript==


(function(){var e;e=".newshelper-warning {\n    background: hsl(0, 50%, 50%);\n    color: white;\n    font-size: large;\n    text-align: center;\n    width: 100%;\n    padding: 5px 0;\n}\n\n.newshelper-warning-facebook {\nbackground: hsl(50, 100%, 70%);\n   color: hsl(0, 0%, 20%);\n   font-size: medium;\n   text-align: center;\n   margin: 20px 0 10px 0;\n   padding: 0 0 10px 0;\n   -webkit-border-radius: 5px;\n      -moz-border-radius: 5px;\n           border-radius: 5px;\n}\n\n.newshelper-description {\n  display: block;\n  font-size: small;\n  margin-top: 5px;\n}\n\n.newshelper-description a {\n  color: hsl(0, 100%, 50%);\n  font-weight: bold;\n  padding-right: 20px;\n  background: transparent url(data:image/gif;base64,R0lGODlhEQDcAKIAAP////8AAGYAmQAzZv///wAAAAAAAAAAACH5BAUUAAQALAAAAAARANwAAAPmSLrc/m7IOeEAON/x9gQXGGVa1XgSyRGSEpLa0qIUSH1w7HL0t7asnI7RS62IQsxRdrtBntCodEqtWq/YrHbL7Xq/4LB4TC6bz+i0es1uu9/wuHxOr9vv+Lx+zxcL/oCAEAI5hAIPhoAAhIsOjCSBjouKGYcEfwqPhQuYiYGen0mNmYegipaYl6KWDKZ/o62rjp+ffba3uLm6u7y9vr/AwcLDxMXGx8jJynIBzc7OEAE50gEP1M4A0tkO2iTP3NnYGdUEzQrd0wvm18/s7aLk5dXu2OTm5fDg7c3bDegw8dTt+7ZsSgIAOw==) no-repeat 100% -200px;\n}\n\n.arrow-up {\n  width: 0;\n  height: 0;\n  border-left: 10px solid transparent;\n  border-right: 10px solid transparent;\n  border-bottom: 10px solid hsl(50, 100%, 70%);\n  position: relative;\n  top: -10px;\n  margin: 0 auto;\n}",function(n){var t,r,a,o,i,u,d,s,c,l,p,f,w,h;t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,r=null,a=function(e){return GM_addStyle(e)},o=function(e){var n;return null!==r?(e(r),void 0):(n=t.open("newshelper","6"),n.onsuccess=function(){return r=n.result,e(r)},n.onerror=function(e){return console.log("IndexedDB error: "+e.target.errorCode)},n.onupgradeneeded=function(e){var n;try{e.currentTarget.result.deleteObjectStore("read_news")}catch(t){}n=e.currentTarget.result.createObjectStore("read_news",{keyPath:"id",autoIncrement:!0}),n.createIndex("title","title",{unique:!1}),n.createIndex("link","link",{unique:!0}),n.createIndex("last_seen_at","last_seen_at",{unique:!1});try{e.currentTarget.result.deleteObjectStore("report")}catch(t){}return n=e.currentTarget.result.createObjectStore("report",{keyPath:"id"}),n.createIndex("news_title","news_title",{unique:!1}),n.createIndex("news_link","news_link",{unique:!1}),n.createIndex("updated_at","updated_at",{unique:!1})})},i=function(e){var n;switch(n=Math.floor((new Date).getTime()/1e3)-e,!0){case 60>n:return n+" 秒前";case 3600>n:return Math.floor(n/60)+" 分鐘前";case 86400>n:return Math.floor(n/60/60)+" 小時前";default:return Math.floor(n/60/60/24)+" 天前"}},u=function(e){return o(function(n){var t,r,a,o;return t=n.transaction("read_news","readonly"),r=t.objectStore("read_news"),a=r.index("link"),o=a.get(e.news_link),o.onsuccess=function(){o.result&&parseInt(o.result.deleted_at,10)}})},d=function(e){return o(function(n){var t,r,a,o;return t=n.transaction("report","readonly"),r=t.objectStore("report"),a=r.index("updated_at"),o=a.openCursor(null,"prev"),o.onsuccess=function(){return o.result?(e(o.result.value),void 0):e(null)}})},s=function(){return o(function(e){return d(function(n){var t,r;return t=null!=(null!=n?n.updated_at:void 0)?parseInt(n.updated_at):0,r="http://newshelper.g0v.tw/index/data?time="+t,GM_xmlhttpRequest({method:"GET",url:r,onload:function(n){var t,r,a,o;if(t=JSON.parse(n.responseText),r=e.transaction("report","readwrite"),a=r.objectStore("report"),t.data)for(o=0;t.data.length>o;)a.put(t.data[o]),u(t.data[o]),o++;return setTimeout(s,3e5)}})})})},c=function(e,n){return e?o(function(t){var r,a,o,i;r=t.transaction("read_news","readwrite"),a=r.objectStore("read_news");try{o=a.add({title:n,link:e,last_seen_at:Math.floor((new Date).getTime()/1e3)})}catch(u){i=u.message,GM_log("Error "+e+" , "+n+" , "+i)}return o.onerror=function(){var r,a,o,i;return r=t.transaction("read_news","readwrite"),a=r.objectStore("read_news"),o=a.index("link"),i=o.get(e),i.onsuccess=function(){var e;return e=a.put({id:i.result.id,title:n,last_seen_at:Math.floor((new Date).getTime()/1e3)})}}}):void 0},l=function(e,n,t){return n?o(function(e){var r,a,o,i;return r=e.transaction("report","readonly"),a=r.objectStore("report"),o=a.index("news_link"),i=o.get(n),i.onsuccess=function(){return i.result&&!parseInt(i.result.deleted_at,10)?t(i.result):void 0}}):void 0},p=function(e){return'<div class="newshelper-warning-facebook"><div class="arrow-up"></div>注意！您可能是<b>問題新聞</b>的受害者<span class="newshelper-description">'+n("<span></span>").append(n("<a></a>").attr({href:e.link,target:"_blank"}).text(e.title)).html()+"</span>"+"</div>"},f=function(e){var t;return-1!==window.location.host.indexOf("www.facebook.com")?(t=function(e,t,r){var a,o,i;return a=(""+r).match("^http://www.facebook.com/l.php\\?u=([^&]*)"),a&&(r=decodeURIComponent(a[1])),e=n(e),o="newshelper-checked",e.hasClass(o)?void 0:(e.addClass(o),i=!1,e.parent("div[role=article]").find(".uiStreamActionFooter").each(function(e,a){var o;return n(a).find("li:first").append("· "+h({title:t,link:r})),o=!0}),i||e.parent("div[role=article]").find(".uiStreamSource").each(function(e,a){return n(n("<span></span>").html(h({title:t,link:r}))).insertBefore(a),0!==e?console.error(e+t):void 0}),c(r,t),l(t,r,function(n){return e.addClass(o),e.append(p({title:n.report_title,link:n.report_link}))}))},n(e).find(".uiStreamAttachments").each(function(e,r){var a,o;return r=n(r),r.hasClass("newshelper-checked")?void 0:(a=r.find(".uiAttachmentTitle").text(),o=r.find("a").attr("href"),t(r,a,o))}),n(e).find(".shareUnit").each(function(e,r){var a,o;return r=n(r),r.hasClass("newshelper-checked")?void 0:(a=r.find(".fwb").text(),o=r.find("a").attr("href"),t(r,a,o))}),n(e).find("._6kv").not("newshelper-checked").each(function(e,r){var a,o;return r=n(r),a=r.find(".mbs").text(),o=r.find("a").attr("href"),t(r,a,o)})):void 0},w=function(){var e,n,t,r;return e=window.MutationObserver||window.WebKitMutationObserver,n={target:document.getElementsByTagName("body")[0],config:{attributes:!0,childList:!0,characterData:!0}},t=function(){var e;return function(n,t){return e&&clearTimeout(e),e=setTimeout(n,t)}}(),r=new e(function(){return t(function(){return f(document.body)},1e3)}),r.observe(n.target,n.config)},h=function(e){var n;return n="http://newshelper.g0v.tw",e.title!==void 0&&e.link!==void 0&&(n+="?news_link="+encodeURIComponent(e.link)+"&news_title= "+encodeURIComponent(e.title)),'<a href="'+n+'" target="_blank">回報給新聞小幫手</a>'},function(){return a(e),f(document.body),s(),w()}()}.call(this,jQuery)}).call(this);