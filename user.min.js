// ==UserScript==
// @name        newshelper
// @namespace   newshelper-userscript.g0v.tw
// @description g0v News Helper
// @author         racklin@gmail.com
// @include     https://www.facebook.com/*
// @include     http://www.facebook.com/*
// @match     https://www.facebook.com/*
// @match     http://www.facebook.com/*
// @run-at         document-end
// @require        http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.9.1.min.js
// @version     1.1
// ==/UserScript==


(function(){var e;e=".newshelper-warning {\n    background: hsl(0, 50%, 50%);\n    color: white;\n    font-size: large;\n    text-align: center;\n    width: 100%;\n    padding: 5px 0;\n}\n\n.newshelper-warning-facebook {\nbackground: hsl(50, 100%, 70%);\n   color: hsl(0, 0%, 20%);\n   font-size: medium;\n   text-align: center;\n   margin: 20px 0 10px 0;\n   padding: 0 0 10px 0;\n   -webkit-border-radius: 5px;\n      -moz-border-radius: 5px;\n           border-radius: 5px;\n}\n\n.newshelper-description {\n  display: block;\n  font-size: small;\n  margin-top: 5px;\n}\n\n.newshelper-description a {\n  color: hsl(0, 100%, 50%);\n  font-weight: bold;\n  padding-right: 20px;\n  background: transparent url(data:image/gif;base64,R0lGODlhEQDcAKIAAP////8AAGYAmQAzZv///wAAAAAAAAAAACH5BAUUAAQALAAAAAARANwAAAPmSLrc/m7IOeEAON/x9gQXGGVa1XgSyRGSEpLa0qIUSH1w7HL0t7asnI7RS62IQsxRdrtBntCodEqtWq/YrHbL7Xq/4LB4TC6bz+i0es1uu9/wuHxOr9vv+Lx+zxcL/oCAEAI5hAIPhoAAhIsOjCSBjouKGYcEfwqPhQuYiYGen0mNmYegipaYl6KWDKZ/o62rjp+ffba3uLm6u7y9vr/AwcLDxMXGx8jJynIBzc7OEAE50gEP1M4A0tkO2iTP3NnYGdUEzQrd0wvm18/s7aLk5dXu2OTm5fDg7c3bDegw8dTt+7ZsSgIAOw==) no-repeat 100% -200px;\n}\n\n.arrow-up {\n  width: 0;\n  height: 0;\n  border-left: 10px solid transparent;\n  border-right: 10px solid transparent;\n  border-bottom: 10px solid hsl(50, 100%, 70%);\n  position: relative;\n  top: -10px;\n  margin: 0 auto;\n}",function(t){var n,r,a,o,i,u,d,s,c,l,p,f,h,w;n=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,r=null,a=function(e){return GM_addStyle(e)},o=function(e){var t;return null!==r?(e(r),void 0):(t=n.open("newshelper","6"),t.onsuccess=function(){var n;return n=t.result,e(n)},t.onerror=function(e){return console.log("IndexedDB error: "+e.target.errorCode)},t.onupgradeneeded=function(e){var t;try{e.currentTarget.result.deleteObjectStore("read_news")}catch(n){}t=e.currentTarget.result.createObjectStore("read_news",{keyPath:"id",autoIncrement:!0}),t.createIndex("title","title",{unique:!1}),t.createIndex("link","link",{unique:!0}),t.createIndex("last_seen_at","last_seen_at",{unique:!1});try{e.currentTarget.result.deleteObjectStore("report")}catch(n){}return t=e.currentTarget.result.createObjectStore("report",{keyPath:"id"}),t.createIndex("news_title","news_title",{unique:!1}),t.createIndex("news_link","news_link",{unique:!1}),t.createIndex("updated_at","updated_at",{unique:!1})})},i=function(e){var t;switch(t=Math.floor((new Date).getTime()/1e3)-e,!0){case 60>t:return t+" 秒前";case 3600>t:return Math.floor(t/60)+" 分鐘前";case 86400>t:return Math.floor(t/60/60)+" 小時前";default:return Math.floor(t/60/60/24)+" 天前"}},u=function(e){return o(function(t){var n,r,a,o;return n=t.transaction("read_news","readonly"),r=n.objectStore("read_news"),a=r.index("link"),o=a.get(e.news_link),o.onsuccess=function(){return o.result&&!parseInt(o.result.deleted_at,10)?chrome.extension.sendRequest({method:"add_notification",title:"新聞小幫手提醒您",body:"您於"+i(o.result.last_seen_at)+" 看的新聞「"+o.result.title+"」 被人回報有錯誤："+e.report_title,link:e.report_link},function(){}):void 0}})},d=function(e){return o(function(t){var n,r,a,o;return n=t.transaction("report","readonly"),r=n.objectStore("report"),a=r.index("updated_at"),o=a.openCursor(null,"prev"),o.onsuccess=function(){return o.result?(e(o.result.value),void 0):e(null)}})},s=function(){return o(function(e){return d(function(t){var n,r;return n=null!=(null!=t?t.updated_at:void 0)?parseInt(t.updated_at):0,r="http://newshelper.g0v.tw/index/data?time="+n,GM_xmlhttpRequest({method:"GET",url:r,onload:function(t){var n,r,a,o;if(n=JSON.parse(t.responseText),r=e.transaction("report","readwrite"),a=r.objectStore("report"),n.data)for(o=0;n.data.length>o;)a.put(n.data[o]),u(n.data[o]),o++;return setTimeout(s,3e5)}})})})},c=function(e,t){return e?o(function(n){var r,a,o,i;r=n.transaction("read_news","readwrite"),a=r.objectStore("read_news");try{o=a.add({title:t,link:e,last_seen_at:Math.floor((new Date).getTime()/1e3)})}catch(u){i=u.message,GM_log("Error "+e+" , "+t+" , "+i)}return o.onerror=function(){var r,a,o,i;return r=n.transaction("read_news","readwrite"),a=r.objectStore("read_news"),o=a.index("link"),i=o.get(e),i.onsuccess=function(){var e;return e=a.put({id:i.result.id,title:t,last_seen_at:Math.floor((new Date).getTime()/1e3)})}}}):void 0},l=function(e,t,n){return t?o(function(e){var r,a,o,i;return r=e.transaction("report","readonly"),a=r.objectStore("report"),o=a.index("news_link"),i=o.get(t),i.onsuccess=function(){return i.result&&!parseInt(i.result.deleted_at,10)?n(i.result):void 0}}):void 0},p=function(e){return'<div class="newshelper-warning-facebook"><div class="arrow-up"></div>注意！您可能是<b>問題新聞</b>的受害者<span class="newshelper-description">'+t("<span></span>").append(t("<a></a>").attr({href:e.link,target:"_blank"}).text(e.title)).html()+"</span>"+"</div>"},f=function(e){var n;return-1!==window.location.host.indexOf("www.facebook.com")?(n=function(e,n,r){var a,o,i;return a=(""+r).match("^http://www.facebook.com/l.php\\?u=([^&]*)"),a&&(r=decodeURIComponent(a[1])),e=t(e),o="newshelper-checked",e.hasClass(o)?void 0:(e.addClass(o),i=!1,e.parent("div[role=article]").find(".uiStreamActionFooter").each(function(e,a){var o;return t(a).find("li:first").append("· "+w({title:n,link:r})),o=!0}),i||e.parent("div[role=article]").find(".uiStreamSource").each(function(e,a){return t(t("<span></span>").html(w({title:n,link:r}))).insertBefore(a),0!==e?console.error(e+n):void 0}),c(r,n),l(n,r,function(t){return e.addClass(o),e.append(p({title:t.report_title,link:t.report_link}))}))},t(e).find(".uiStreamAttachments").each(function(e,r){var a,o;return r=t(r),r.hasClass("newshelper-checked")?void 0:(a=r.find(".uiAttachmentTitle").text(),o=r.find("a").attr("href"),n(r,a,o))}),t(e).find(".shareUnit").each(function(e,r){var a,o;return r=t(r),r.hasClass("newshelper-checked")?void 0:(a=r.find(".fwb").text(),o=r.find("a").attr("href"),n(r,a,o))}),t(e).find("._6kv").each(function(e,r){var a,o;return r=t(r),r.hasClass("newshelper-checked")?void 0:(a=r.find(".mbs").text(),o=r.find("a").attr("href"),n(r,a,o))})):void 0},h=function(){var e,t,n,r;return e=window.MutationObserver||window.WebKitMutationObserver,t={target:document.getElementsByTagName("body")[0],config:{attributes:!0,childList:!0,characterData:!0}},n=function(){return function(e,t){var n;return n&&clearTimeout(n),n=setTimeout(e,t)}},r=new e(function(){return n(function(){return f(document.body)},1e3)}),r.observe(t.target,t.config)},w=function(e){var t;return t="http://newshelper.g0v.tw",e.title!==void 0&&e.link!==void 0&&(t+="?news_link="+encodeURIComponent(e.link)+"&news_title= "+encodeURIComponent(e.title)),'<a href="'+t+'" target="_blank">回報給新聞小幫手</a>'},function(){return a(e),f(document.body),s(),h()}()}.call(this,jQuery)}).call(this);